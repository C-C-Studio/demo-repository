<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>WebXR AR Ground Test</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0,0,0,0.4);
        padding: 8px 12px;
        border-radius: 8px;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="info">ðŸ“± Arahkan kamera ke lantai untuk menempatkan objek 3D</div>

    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.164/build/three.module.js';
      import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.164/examples/jsm/webxr/ARButton.js';

      let camera, scene, renderer, controller;
      let reticle, arrowMesh;

      init();
      animate();

      function init() {
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Cahaya lembut
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        scene.add(light);

        // Reticle (penanda tempat objek akan muncul di ground)
        const geometry = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI / 2);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        reticle = new THREE.Mesh(geometry, material);
        reticle.matrixAutoUpdate = false;
        reticle.visible = false;
        scene.add(reticle);

        // Arrow 3D (objek panah)
        const arrowGeo = new THREE.ConeGeometry(0.05, 0.15, 16);
        const arrowMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
        arrowMesh = new THREE.Mesh(arrowGeo, arrowMat);
        arrowMesh.rotation.x = -Math.PI / 2;
        arrowMesh.visible = false;
        scene.add(arrowMesh);

        // AR Button
        const button = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
        document.body.appendChild(button);

        // Hit test untuk menempel di ground
        renderer.xr.addEventListener('sessionstart', () => {
          const session = renderer.xr.getSession();
          session.requestReferenceSpace('viewer').then(referenceSpace => {
            session.requestHitTestSource({ space: referenceSpace }).then(source => {
              renderer.setAnimationLoop((timestamp, frame) => {
                if (frame) {
                  const referenceSpaceLocal = renderer.xr.getReferenceSpace();
                  const hitTestResults = frame.getHitTestResults(source);

                  if (hitTestResults.length) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(referenceSpaceLocal);

                    reticle.visible = true;
                    reticle.matrix.fromArray(pose.transform.matrix);
                  } else {
                    reticle.visible = false;
                  }
                }

                renderer.render(scene, camera);
              });
            });
          });
        });

        // Tap untuk menempatkan panah
        controller = renderer.xr.getController(0);
        controller.addEventListener('select', () => {
          if (reticle.visible) {
            arrowMesh.position.setFromMatrixPosition(reticle.matrix);
            arrowMesh.visible = true;
          }
        });
        scene.add(controller);

        window.addEventListener('resize', onWindowResize);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        renderer.setAnimationLoop(() => {
          renderer.render(scene, camera);
        });
      }
    </script>
  </body>
</html>
